<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title><?= $title ?? "Мой сайт" ?></title>

  <!-- Подключаем общий CSS -->
  <link rel="stylesheet" href="/massage_salon/css/massage.css">
  <link rel="stylesheet" href="/massage_salon/css/main.css">

  <!-- Подключаем Font Awesome для иконок -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<div class="massage-block">
  <?php foreach ($groupedMassages as $ser_id => $massage): ?>
    <?php
      $fullDescription = $massage['description'] ?? '';
      $shortDescription = htmlspecialchars(mb_substr(strip_tags($fullDescription), 0, 150)) . '...';
      $paragraphs = preg_split("/\n\s*\n/", $fullDescription);

      $fullDescriptionHTML = '';
      $ulOpened = false;
      foreach ($paragraphs as $para) {
        $para = trim($para);
        if (!$para) continue;

        if (str_starts_with($para, '–')) {
          if (!$ulOpened) { $fullDescriptionHTML .= '<ul>'; $ulOpened = true; }
          $fullDescriptionHTML .= '<li>' . htmlspecialchars(ltrim($para, '– ')) . '</li>';
        } else {
          if ($ulOpened) { $fullDescriptionHTML .= '</ul>'; $ulOpened = false; }
          $fullDescriptionHTML .= '<p>' . htmlspecialchars($para) . '</p>';
        }
      }
      if ($ulOpened) $fullDescriptionHTML .= '</ul>';
    ?>

    <div class="massage-container">
      <div class="image-block">
        <img src="<?= htmlspecialchars($massage['image_path']) ?>" alt="<?= htmlspecialchars($massage['name']) ?>" loading="lazy">
      </div>
      <div class="description-block">
        <h2><?= htmlspecialchars($massage['name']) ?></h2>
        <p class="short-description"><?= $shortDescription ?></p>
        <div class="full-description" style="display:none;">
          <?= $fullDescriptionHTML ?>
        </div>

        <div class="time-price-container" style="display:none;">
          <label for="time-select-<?= $ser_id ?>">Select Time:</label>
          <select id="time-select-<?= $ser_id ?>" onchange="updatePrice(<?= $ser_id ?>)">
            <?php foreach ($massage['times'] as $index => $time): ?>
              <option value="<?= $massage['prices'][$index] ?>"><?= htmlspecialchars($time) ?> minutes</option>
            <?php endforeach; ?>
          </select>
          <p>Price: <span id="price-<?= $ser_id ?>"><?= htmlspecialchars($massage['prices'][0]) ?>zł</span></p>
        </div>

        <div class="button-container">
          <button class="btn" onclick="showMore(<?= $ser_id ?>)">Show More</button>
        </div>
      </div>
    </div>
  <?php endforeach; ?>
</div>

<script>
function showMore(ser_id) {
  const block = document.querySelectorAll('.description-block')[ser_id - 1];
  block.querySelector('.short-description').style.display = 'none';
  block.querySelector('.full-description').style.display = 'block';
  block.querySelector('.time-price-container').style.display = 'flex';

  const buttons = block.querySelector('.button-container');
  buttons.innerHTML = '';

  const closeBtn = document.createElement('button');
  closeBtn.className = 'btn';
  closeBtn.textContent = 'Close';
  closeBtn.onclick = () => closeDescription(ser_id);
  buttons.appendChild(closeBtn);

  const bookBtn = document.createElement('button');
  bookBtn.className = 'book-button';
  bookBtn.textContent = 'Book';
  bookBtn.onclick = () => location.href = `booking.php?ser_id=${ser_id}`;
  buttons.appendChild(bookBtn);
}

function closeDescription(ser_id) {
  const block = document.querySelectorAll('.description-block')[ser_id - 1];
  block.querySelector('.short-description').style.display = 'block';
  block.querySelector('.full-description').style.display = 'none';
  block.querySelector('.time-price-container').style.display = 'none';

  const buttons = block.querySelector('.button-container');
  buttons.innerHTML = `<button class="btn" onclick="showMore(${ser_id})">Show More</button>`;
}

function updatePrice(ser_id) {
  const select = document.getElementById(`time-select-${ser_id}`);
  document.getElementById(`price-${ser_id}`).textContent = `${select.value}zł`;
}
</script>
</html>
